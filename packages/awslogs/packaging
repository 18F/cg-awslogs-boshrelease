set -e # exit immediately if a simple command exits with a non-zero status
set -u # report the usage of uninitialized variables

# Available variables
# $BOSH_COMPILE_TARGET - where this package & spec'd source files are available
# $BOSH_INSTALL_TARGET - where you copy/install files to be included in package

# Detect # of CPUs so make jobs can be parallelized
CPUS=$(grep -c ^processor /proc/cpuinfo)
export PREFIX=${BOSH_INSTALL_TARGET}
export PATH=$PREFIX/bin:$PATH
export CPPFLAGS="-I${BOSH_INSTALL_TARGET}/include"
export LDFLAGS="-L${BOSH_INSTALL_TARGET}/lib"
export LIBRARY_PATH="${BOSH_INSTALL_TARGET}/lib"
export LD_LIBRARY_PATH="${LIBRARY_PATH}"
export CFLAGS="-fPIC"


tar xzf bzip2-1.0.6.tar.gz
(
  set -e
  cd bzip2-1.0.6
  make -f Makefile-libbz2_so
  make -j${CPUS}
  make install PREFIX=${BOSH_INSTALL_TARGET}
  cp -a *.so* ${BOSH_INSTALL_TARGET}/lib
)

tar xzf zlib-1.2.8.tar.gz
(
  set -e
  cd zlib-1.2.8
  ./configure --prefix=${BOSH_INSTALL_TARGET}
  make -j${CPUS}
  make install
)

tar xzf openssl-1.0.2h.tar.gz
(
  set -e
  cd openssl-1.0.2h
  ./config --prefix=${BOSH_INSTALL_TARGET} --openssldir=${BOSH_INSTALL_TARGET}/openssl shared zlib
  make -j${CPUS}
  make install
)

export CPPFLAGS="${CPPFLAGS} -I${BOSH_INSTALL_TARGET}/include/openssl"

tar xzf sqlite-autoconf-3130000.tar.gz
(
  set -e
  cd sqlite-autoconf-3130000
  ./configure --prefix=${BOSH_INSTALL_TARGET}
  make -j${CPUS}
  make install
)

tar xzf Python-2.7.10.tgz
(
  set -e
  cd Python-2.7.10
    ./configure --prefix=${BOSH_INSTALL_TARGET}
  make -j${CPUS}
  make install
)

mkdir -p ${BOSH_INSTALL_TARGET}/lib/python2.7/site-packages
export PYTHONPATH="${BOSH_INSTALL_TARGET}/lib/python2.7/site-packages"

tar xzf setuptools-21.0.0.tar.gz
(
  set -e
  cd setuptools-21.0.0
  ${BOSH_INSTALL_TARGET}/bin/python2 setup.py install --prefix=${BOSH_INSTALL_TARGET}
)

tar xzf pip-8.1.1.tar.gz
(
  set -e
  BOSH_PACKAGES_DIR=${BOSH_PACKAGES_DIR:-/var/vcap/packages}

  cd pip-8.1.1
  ${BOSH_INSTALL_TARGET}/bin/python2 setup.py install --prefix=${BOSH_INSTALL_TARGET}
)

${BOSH_INSTALL_TARGET}/bin/pip install pysqlite-2.8.2.tar.gz
${BOSH_INSTALL_TARGET}/bin/pip install six-1.10.0-py2.py3-none-any.whl
${BOSH_INSTALL_TARGET}/bin/pip install py-dateutil-2.2.tar.gz
${BOSH_INSTALL_TARGET}/bin/pip install awscli-cwlogs-1.3.3.tar.gz

unzip aws-cli/awscli-bundle.zip
./awscli-bundle/install -i $BOSH_INSTALL_TARGET/aws-cli


