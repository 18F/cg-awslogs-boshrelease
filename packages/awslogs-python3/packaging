set -e -x

# Detect # of CPUs so make jobs can be parallelized
CPUS=`grep -c ^processor /proc/cpuinfo`

export CFLAGS="-fPIC ${CFLAGS}"
export LDFLAGS="-L/var/vcap/packages/openssl/lib ${LDFLAGS}"
export CPPFLAGS="-I/var/vcap/packages/openssl/include ${CPPFLAGS}"
export LD_LIBRARY_PATH="/var/vcap/packages/openssl/lib:${LIBRARY_PATH}"

apt-get update
apt-get install -y build-essential \
                   libsqlite3-dev \
                   sqlite3 \
                   bzip2 \
                   libbz2-dev \
                   libssl-dev \
                   libgdbm-dev \
                   liblzma-dev \
                   libreadline-dev \
                   libncursesw5-dev \
                   libffi-dev \
                   uuid-dev

echo "Extracting python..."
tar xzvf Python-3.7.1.tgz

echo "Building python..."
pushd Python-3.7.1
  ./configure --prefix=${BOSH_INSTALL_TARGET}
  make -j${CPUS}
  make install
popd
